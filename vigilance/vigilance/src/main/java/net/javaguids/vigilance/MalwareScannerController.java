package net.javaguids.vigilance;

import org.springframework.web.bind.annotation.*;
import java.util.*;

@RestController
@RequestMapping("/api/v1/malware-scanner")
public class MalwareScannerController {

    @GetMapping("/scan")
    public Map<String, Object> scanUrl(@RequestParam String url) {
        Map<String, Object> result = new HashMap<>();

        // Validate the URL format
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            result.put("error", "Invalid URL scheme. URL must start with http:// or https://");
            return result;
        }

        // Placeholder for results
        List<String> infectedFiles = new ArrayList<>();
        List<String> fileUrls = MalwareScanner.extractFilesFromWebsite(url);

        // Scan logic
        int scannedCount = 0;
        for (String fileUrl : fileUrls) {
            byte[] fileContent = MalwareScanner.downloadFile(fileUrl);
            if (fileContent != null && MalwareScanner.isExecutableFile(fileUrl)) {
                String fileHash = MalwareScanner.calculateSHA256(fileContent);
                if (MalwareScanner.MALWARE_SIGNATURES.containsKey(fileHash)) {
                    infectedFiles.add(fileUrl);
                } else if (MalwareScanner.containsSuspiciousPatterns(new String(fileContent))) {
                    infectedFiles.add(fileUrl);
                }
            }
            scannedCount++;
        }

        // Add results to response
        result.put("targetURL", url);
        result.put("totalFilesScanned", scannedCount);
        result.put("infectedFiles", infectedFiles);
        result.put("totalInfectedFiles", infectedFiles.size());

        return result;
    }
}
